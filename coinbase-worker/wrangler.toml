name = "coinbase-worker"
main = "build/worker/shim.mjs"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Account ID (set via environment or wrangler login)
# account_id = "your-account-id"

[build]
command = "cargo install -q worker-build && worker-build --release"

# KV namespace for trading state
[[kv_namespaces]]
binding = "STATE"
id = "278e140578db4e768688636f18d2d4ae"

# Environment variables (secrets set via wrangler secret)
[vars]
ENVIRONMENT = "production"
LOG_LEVEL = "info"

# Exit parameters (now used as fallback/bounds)
TAKE_PROFIT_PERCENT = "2.0"    # Fallback TP if ATR calc fails
STOP_LOSS_PERCENT = "1.5"      # Fallback SL if ATR calc fails
TRAILING_STOP_PERCENT = "0.75" # Trail 0.75% below peak

# Volatility-Adaptive TP/SL (ATR-based)
ATR_SL_MULTIPLIER = "1.0"      # SL at 1x ATR below entry
ATR_TP_MULTIPLIER = "2.0"      # TP at 2x ATR above entry (2:1 R:R)
MIN_SL_PERCENT = "0.5"         # Min stop-loss (prevent too tight)
MAX_SL_PERCENT = "5.0"         # Max stop-loss (prevent too wide)
MIN_TP_PERCENT = "1.0"         # Min take-profit
MAX_TP_PERCENT = "10.0"        # Max take-profit

# Dynamic Position Sizing (Risk-Based)
# Note: These are BASE values - actual values are adjusted by CapitalTier
MAX_RISK_PER_TRADE_PERCENT = "2.0"    # Base risk % (tier-adjusted: 0.5-2%)
MAX_PORTFOLIO_PER_POSITION = "25.0"   # Base max % per position (tier-adjusted: 20-80%)
MIN_POSITION_USD = "10"               # Absolute Coinbase minimum
CASH_RESERVE_PERCENT = "15.0"         # Keep 15% cash for opportunities
MAX_TOTAL_POSITIONS = "8"             # Hard cap (tier-adjusted: 1-5)

# Fee Configuration (Coinbase Advanced Trade - Taker Fees)
# Bot tracks 30-day volume and auto-adjusts fee assumption
BASE_FEE_PERCENT = "0.60"             # Default fee tier ($0-$1K volume)
# Fee tiers: $0-1K=0.60%, $1K-10K=0.40%, $10K-50K=0.25%, $50K+=0.20%

# Adaptive Entry Threshold
# Base threshold auto-adjusts based on recent win rate
BASE_ENTRY_THRESHOLD = "60.0"         # Base score needed to enter (0-100)
MIN_ENTRY_THRESHOLD = "40.0"          # Floor (never too permissive)
MAX_ENTRY_THRESHOLD = "85.0"          # Ceiling (never too restrictive)

CYCLE_INTERVAL_SECONDS = "15"

# Crypto symbols to trade (more = more opportunities)
SYMBOLS = "BTC-USD,ETH-USD,SOL-USD,DOGE-USD,AVAX-USD,LINK-USD,XRP-USD,ADA-USD"

# Risk management
DAILY_TRADE_LIMIT = "30"
MAX_CONSECUTIVE_ERRORS = "5"

# Strategy filters
ENABLE_TREND_FILTER = "true"    # Only buy dips in uptrends (price > 6h avg)
ENABLE_VOLUME_FILTER = "true"   # Only trade high-volume coins
ENABLE_MARKET_REGIME_FILTER = "true"  # Only trade when BTC is green (market bullish)
MIN_VOLUME_USD = "1000000"      # Minimum $1M 24h volume
MAX_POSITION_AGE_HOURS = "48"   # Close positions after 48h if no TP/SL hit (give trades time)

# Scheduled triggers (cron)
[triggers]
# Run every minute (Cloudflare minimum)
crons = ["* * * * *"]

# Development overrides
[env.dev]
vars = { ENVIRONMENT = "development", LOG_LEVEL = "debug" }

[env.staging]
vars = { ENVIRONMENT = "staging", LOG_LEVEL = "debug" }
